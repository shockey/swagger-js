meta:
  title: "SWOS-109: instantiation cases"
cases:
- name: cross-document $ref
  remoteDocuments:
    a.yaml:
      openapi: 3.0.2
      components:
        schemas:
          MessageWidgetData:
            $ref: "./b.yaml#/components/schemas/Action"
    b.yaml:
      openapi: 3.0.2
      components:
        schemas:
          Action:
            properties:
              confirmation:
                $ref: '#/components/schemas/ActionConfirmation'
          ActionConfirmation:
            properties:
              dismiss_action:
                type: string
  action:
    type: instantiateResolve
    config:
      url: "http://mock.swagger.test/a.yaml"
  assertions:
  - equal:
      openapi: 3.0.2
      components:
        schemas:
          MessageWidgetData:
            $$ref: "http://mock.swagger.test/b.yaml#/components/schemas/Action"
            properties:
              confirmation:
                $$ref: "http://mock.swagger.test/b.yaml#/components/schemas/ActionConfirmation"
                properties:
                  dismiss_action:
                    type: string
- name: cross-document $ref within allOf
  remoteDocuments:
    a.yaml:
      openapi: 3.0.2
      components:
        schemas:
          MessageWidgetData:
            allOf:
              - $ref: "./b.yaml#/components/schemas/Action"
    b.yaml:
      openapi: 3.0.2
      components:
        schemas:
          Action:
            properties:
              confirmation:
                $ref: '#/components/schemas/ActionConfirmation'
          ActionConfirmation:
            properties:
              dismiss_action:
                type: string
  action:
    type: instantiateResolve
    config:
      url: "http://mock.swagger.test/a.yaml"
  assertions:
  - equal:
      openapi: 3.0.2
      components:
        schemas:
          MessageWidgetData:
            properties:
              confirmation:
                $$ref: "http://mock.swagger.test/b.yaml#/components/schemas/ActionConfirmation"
                properties:
                  dismiss_action:
                    type: string
- name: cross-document $ref within allOf with a circular reference
  remoteDocuments:
    a.yaml:
      openapi: 3.0.2
      components:
        schemas:
          MessageWidgetData:
            allOf:
              - $ref: "./b.yaml#/components/schemas/Action"
    b.yaml:
      openapi: 3.0.2
      components:
        schemas:
          Action:
            properties:
              confirmation:
                $ref: '#/components/schemas/ActionConfirmation'
          ActionConfirmation:
            properties:
              dismiss_action:
                $ref: '#/components/schemas/Action'
  action:
    type: instantiateResolve
    config:
      url: "http://mock.swagger.test/a.yaml"
  assertions:
  - equal:
      openapi: 3.0.2
      components:
        schemas:
          MessageWidgetData:
            # $$ref intentionally omitted here
            properties: &circularRefAnchor
              confirmation:
                $$ref: "http://mock.swagger.test/b.yaml#/components/schemas/ActionConfirmation"
                properties:
                  dismiss_action:
                    $$ref: 'http://mock.swagger.test/b.yaml#/components/schemas/Action'
                    properties: *circularRefAnchor